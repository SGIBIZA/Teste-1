<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Indicadores N3 - Filtro por Mês e Ano</title>
<style>
  body {
    font-family: Arial, sans-serif;
    margin: 0;
    background: #f2f2f2;
  }

  /* Cabeçalho no padrão BIZA */
  .topo {
    background: #000;
    padding: 25px;
    text-align: center;
  }

  .topo h1 {
    margin: 0;
    color: #F8AD1E; /* Laranja GHT */
    font-size: 32px;
    font-weight: bold;
  }

  /* Área de filtros */
  .filtros {
    padding: 20px 30px;
  }

  label {
    font-weight: bold;
    margin-right: 8px;
  }

  select {
    padding: 10px;
    border-radius: 6px;
    border: 1px solid #ccc;
    margin-right: 15px;
    font-size: 15px;
  }

  button {
    padding: 10px 18px;
    border-radius: 6px;
    border: none;
    background: #F8AD1E;
    color: black;
    font-weight: bold;
    cursor: pointer;
  }

  button:hover {
    background: #e19b16;
  }

  /* Tabela */
  table {
    width: 95%;
    margin: 20px auto;
    border-collapse: collapse;
    background: white;
    border-radius: 10px;
    overflow: hidden;
    display: none;
  }

  th {
    background: #444; 
    color: white;
    font-size: 14px;
    padding: 10px;
    text-align: left;
  }

  td {
    padding: 10px;
    border-bottom: 1px solid #ddd;
  }

  tr:nth-child(even) {
    background: #f9f9f9;
  }

  tr:hover {
    background: #f1f1f1;
  }
</style>

</head>
<body>

<div class="topo">
  <h1>Filtro de Indicadores N3</h1>
</div>

<div class="filtros">
  <label>Mês:</label>
  <select id="filtroMes"></select>

  <label>Ano:</label>
  <select id="filtroAno"></select>

  <button onclick="filtrar()">Filtrar</button>
</div>

<table id="tabelaResultado">
  <thead id="cabecalho"></thead>
  <tbody id="corpoTabela"></tbody>
</table>

<script>
// Caminho do CSV direto do GitHub
const CSV_URL = "https://raw.githubusercontent.com/SGIBIZA/Teste-1/main/base_n3.csv";

// Variáveis globais
let dadosCSV = [];
let cabecalhos = [];

document.addEventListener("DOMContentLoaded", () => {
  carregarCSV();
});

// -----------------------------
// 1) Carregar CSV do GitHub
// -----------------------------
function carregarCSV() {
  fetch(CSV_URL)
    .then(resp => resp.text())
    .then(texto => {
      processarCSV(texto);
      preencherFiltros();
    })
    .catch(err => console.error("Erro ao carregar CSV:", err));
}

// -----------------------------
// 2) Processar CSV
// -----------------------------
function processarCSV(texto) {
  const linhas = texto.split("\n").map(l => l.trim()).filter(l => l);

  // Remove BOM
  let header = linhas[0].replace(/^\uFEFF/, '').split(";");

  // Normalização dos nomes das colunas
  cabecalhos = header.map(c =>
    c.normalize("NFD")
     .replace(/[\u0300-\u036f]/g, "") // remove acentos
     .replace(/[^a-zA-Z0-9 ]/g, "")   // remove caracteres � e outros
     .trim()
  );

  linhas.shift(); // remove a linha do cabeçalho

  dadosCSV = linhas.map(linha => {
    const colunas = linha.split(";");
    const item = {};

    cabecalhos.forEach((c, i) => {
      item[c] = colunas[i] || "";
    });

    return item;
  });
}


// -----------------------------
// 3) Criar filtros de Mês e Ano
// -----------------------------
function preencherFiltros() {
  const filtroMes = document.getElementById("filtroMes");
  const filtroAno = document.getElementById("filtroAno");

  let meses = new Set();
  let anos = new Set();

  dadosCSV.forEach(item => {
    meses.add(item["Mes texto"]);
    anos.add(item["Ano"]);
  });

  filtroMes.innerHTML = "<option value=''>Selecione</option>";
  filtroAno.innerHTML = "<option value=''>Selecione</option>";

  meses.forEach(m => filtroMes.innerHTML += `<option value="${m}">${m}</option>`);
  anos.forEach(a => filtroAno.innerHTML += `<option value="${a}">${a}</option>`);
}

// -----------------------------
// 4) Filtrar e montar a tabela
// -----------------------------
function filtrar() {
  const mes = document.getElementById("filtroMes").value;
  const ano = document.getElementById("filtroAno").value;

  const tabela = document.getElementById("tabelaResultado");
  const cabeca = document.getElementById("cabecalho");
  const corpo = document.getElementById("corpoTabela");

  if (!mes || !ano) {
    alert("Selecione Mês e Ano para filtrar.");
    return;
  }

  const filtrados = dadosCSV.filter(item =>
    item["Mes texto"] === mes && item["Ano"] === ano
  );

  // Cabeçalho
  cabeca.innerHTML = "<tr>" + cabecalhos.map(c => `<th>${c}</th>`).join("") + "</tr>";

  // Corpo
  corpo.innerHTML = "";
  filtrados.forEach(item => {
    const linha = "<tr>" + cabecalhos.map(c => `<td>${item[c]}</td>`).join("") + "</tr>";
    corpo.innerHTML += linha;
  });

  tabela.style.display = "table";
}
</script>

</body>
</html>